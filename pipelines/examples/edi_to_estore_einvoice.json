{
  "name": "EDI to eStore eInvoice",
  "description": "Converts EDI files to eStore eInvoice format for retail systems. Mimics convert_to_estore_einvoice.py behavior.",
  "backend_mimics": ["convert_to_estore_einvoice.py"],
  "nodes": [
    {
      "id": "input_1",
      "type": "folderSource",
      "position": { "x": 100, "y": 200 },
      "data": {
        "label": "EDI Input",
        "protocol": "local",
        "config": { "path": "/data/incoming/edi" }
      }
    },
    {
      "id": "query_1",
      "type": "query",
      "position": { "x": 300, "y": 200 },
      "data": {
        "label": "Parse EDI",
        "queryType": "python",
        "mode": "transform",
        "query": "# Parse EDI for eStore\nevents = input.split('\\n')\na_rec = [e for e in events if e.startswith('A')][0] if [e for e in events if e.startswith('A')] else ''\nb_recs = [e for e in events if e.startswith('B')]\nc_recs = [e for e in events if e.startswith('C')]\noutput = {\n    'store_number': 'STORE001',\n    'vendor_oid': 'VENDOR001',\n    'invoice_num': a_rec[7:17].strip() if a_rec else '',\n    'invoice_date': a_rec[17:25] if a_rec else '',\n    'b_records': b_recs,\n    'c_records': c_recs\n}"
      }
    },
    {
      "id": "transform_1",
      "type": "transform",
      "position": { "x": 500, "y": 200 },
      "data": {
        "label": "Map GTIN/UPC",
        "transformations": "[\n  { \"field\": \"gtin\", \"expression\": \"b[10:22].strip()\", \"alias\": \"GTIN\" },\n  { \"field\": \"item_code\", \"expression\": \"b[22:32].strip()\", \"alias\": \"ItemCode\" },\n  { \"field\": \"item_desc\", \"expression\": \"b[32:72].strip()\", \"alias\": \"Description\" },\n  { \"field\": \"shipper_qty\", \"expression\": \"int(b[72:78]) * int(b[78:80])\", \"alias\": \"ShipperQuantity\" },\n  { \"field\": \"unit_cost\", \"expression\": \"float(b[80:91]) / 100\", \"alias\": \"UnitCost\" },\n  { \"field\": \"extended_cost\", \"expression\": \"int(b[72:78]) * int(b[78:80]) * float(b[80:91]) / 100\", \"alias\": \"ExtendedCost\" }\n]"
      }
    },
    {
      "id": "router_1",
      "type": "router",
      "position": { "x": 700, "y": 200 },
      "data": {
        "label": "Route by Shipper Mode",
        "conditions": "[{ \"field\": \"shipper_qty\", \"operator\": \"greater\", \"value\": \"0\" }]",
        "logic": "AND"
      }
    },
    {
      "id": "transform_2",
      "type": "transform",
      "position": { "x": 900, "y": 100 },
      "data": {
        "label": "Parent Items",
        "transformations": "[\n  { \"field\": \"line_type\", \"expression\": \"'P'\", \"alias\": \"LineType\" },\n  { \"field\": \"parent_sku\", \"expression\": \"gtin\", \"alias\": \"ParentSKU\" }\n]"
      }
    },
    {
      "id": "transform_3",
      "type": "transform",
      "position": { "x": 900, "y": 300 },
      "data": {
        "label": "Child Items",
        "transformations": "[\n  { \"field\": \"line_type\", \"expression\": \"'C'\", \"alias\": \"LineType\" },\n  { \"field\": \"parent_sku\", \"expression\": \"lookup.parent_sku\", \"alias\": \"ParentSKU\" }\n]"
      }
    },
    {
      "id": "union_1",
      "type": "union",
      "position": { "x": 1100, "y": 200 },
      "data": {
        "label": "Combine All Lines"
      }
    },
    {
      "id": "transform_4",
      "type": "transform",
      "position": { "x": 1300, "y": 200 },
      "data": {
        "label": "Add Trailer Record",
        "transformations": "[\n  { \"field\": \"trailer_line\", \"expression\": \"'TRAILER' + str(total_invoices) + str(sum(extended_cost))\", \"alias\": \"Trailer\" }\n]"
      }
    },
    {
      "id": "profile_1",
      "type": "profile",
      "position": { "x": 1500, "y": 200 },
      "data": {
        "label": "eStore CSV Profile",
        "format": "csv"
      }
    },
    {
      "id": "output_1",
      "type": "output",
      "position": { "x": 1700, "y": 200 },
      "data": {
        "label": "Write eStore CSV",
        "protocol": "local",
        "config": { "path": "/data/output/estore", "naming": "eInvoice_{{date}}.csv" }
      }
    }
  ],
  "edges": [
    { "source": "input_1", "target": "query_1" },
    { "source": "query_1", "target": "transform_1" },
    { "source": "transform_1", "target": "router_1" },
    { "source": "router_1", "target": "transform_2", "sourceHandle": "true" },
    { "source": "router_1", "target": "transform_3", "sourceHandle": "false" },
    { "source": "transform_2", "target": "union_1" },
    { "source": "transform_3", "target": "union_1" },
    { "source": "union_1", "target": "transform_4" },
    { "source": "transform_4", "target": "profile_1" },
    { "source": "profile_1", "target": "output_1" }
  ],
  "settings": {
    "estore_store_number": "STORE001",
    "estore_Vendor_OId": "VENDOR001"
  }
}
