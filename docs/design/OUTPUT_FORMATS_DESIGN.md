# Output Formats Design Document

## 1. Overview

This document details the specifications for all output formats generated by the Batch File Processor application. The application ingests EDI-like files (typically containing A, B, and C records) and converts them into various formats suitable for different downstream systems (POS, Accounting, Reporting).

The conversion process is handled by specific backend modules, each responsible for a distinct output format. Common operations across converters include:
*   **Parsing**: Reading the input EDI file using `utils.capture_records`.
*   **Data Enrichment**: Looking up additional data (UPCs, Customer Info) via database queries or lookup tables.
*   **Formatting**: Structuring the data into CSV, Fixed-Width, or Excel formats.
*   **File Naming**: Generating output filenames, often based on the input filename or specific naming conventions.

## 2. Format Specifications

### 2.1. Standard CSV (`convert_to_csv.py`)

A general-purpose CSV format containing item details.

*   **File Naming Convention**: `<input_filename>.csv`
*   **File Type**: CSV
*   **Encoding**: UTF-8
*   **Line Endings**: `\r\n` (Windows)
*   **Delimiters**: Comma (`,`)
*   **Quoting**: `csv.QUOTE_ALL` (All fields are quoted)

#### Structure & Fields

**Header Row** (Optional, controlled by `include_headers`):
`"UPC", "Qty. Shipped", "Cost", "Suggested Retail", "Description", "Case Pack", "Item Number"`

**Record Types**:
*   **A Record** (Header): Optional.
*   **B Record** (Item Detail): Mapped to columns.
*   **C Record** (Charges/Comments): Appended as rows with specific structure.

**A Record Fields** (if `include_a_records` is True):
Written as: `[Record Type, Customer/Vendor, Invoice Number, Invoice Date, Invoice Total]`

**Field Definitions (B Records)**:

| Field Name | Data Type | Source | Description/Logic |
| :--- | :--- | :--- | :--- |
| UPC | String | Lookup/Input | UPC from lookup table or input. Supports padding, check digit calculation, and UPCE conversion. |
| Qty. Shipped | Integer | Input | Quantity of units. Leading zeros stripped. |
| Cost | Decimal | Input | Unit cost. Formatted as `0.00`. |
| Suggested Retail | Decimal | Input | SRP. Formatted as `0.00`. |
| Description | String | Input | Item description. Ampersands can be filtered (`&` -> `AND`). |
| Case Pack | Integer | Input | Unit multiplier. Leading zeros stripped. |
| Item Number | Integer | Input | Vendor item number. Leading zeros stripped. |

**Specific Logic**:
*   **Retail UOM**: If `retail_uom` is enabled:
    *   Unit Cost = (Cost / 100) / Unit Multiplier
    *   Qty = Unit Multiplier * Qty
    *   Unit Multiplier is set to 1
    *   UPC is updated from lookup

**Example Output**:
```csv
"UPC","Qty. Shipped","Cost","Suggested Retail","Description","Case Pack","Item Number"
"012345678905","12","10.50","19.99","WIDGET A","12","1001"
```

**C Records**:
Written as: `[Record Type, Charge Type, Description, Amount]`

---

### 2.2. Simplified CSV (`convert_to_simplified_csv.py`)

A streamlined CSV format with configurable column ordering.

*   **File Naming Convention**: `<input_filename>.csv`
*   **File Type**: CSV
*   **Encoding**: UTF-8
*   **Line Endings**: `\r\n` (Windows)
*   **Delimiters**: Comma (`,`)

#### Structure & Fields

**Header Row** (Optional):
The header row labels are fixed strings corresponding to the selected fields.
Default available headers: `"UPC", "Quantity", "Cost", "Item Description", "Item Number"`

**Field Definitions**:

| Field Key | Header Label | Data Type | Description |
| :--- | :--- | :--- | :--- |
| upc_number | UPC | String | UPC code. |
| qty_of_units | Quantity | Integer | Quantity. Handles negative values (e.g., "-1" -> -1). |
| unit_cost | Cost | Decimal | Unit cost. |
| description | Item Description | String | Item description. |
| vendor_item | Item Number | Integer | Item number. |

**Specific Logic**:
*   **Retail UOM**: If `retail_uom` is enabled:
    *   Unit Cost = (Cost / 100) / Unit Multiplier
    *   Qty = Unit Multiplier * Qty
    *   Unit Multiplier is set to 1
    *   UPC is updated from lookup

---

### 2.3. E-Store E-Invoice (`convert_to_estore_einvoice.py`)

A complex CSV format designed for E-Store integration, featuring hierarchical item structures (Shippers).

*   **File Naming Convention**: `eInv<VendorName>.<YYYYMMDDHHMMSS>.csv`
*   **File Type**: CSV
*   **Encoding**: UTF-8
*   **Line Endings**: `\r\n` (Windows)

#### Structure

Does not use a standard header row. Uses Record Types in the first column to denote row meaning.

**Record Types**:
*   **H**: Header (Invoice level)
*   **D**: Detail (Item level)
*   **C**: Comment/Child (Shipper content)
*   **T**: Trailer (Invoice Total)

**Field Definitions**:

**H Record**:
`Record Type, Store Number, Vendor OId, Invoice Number, Purchase Order, Invoice Date`

**D Record**:
`Record Type, Detail Type, Subcategory OId, Vendor Item, Vendor Pack, Item Description, Item Pack, GTIN, GTIN Type, QTY, Unit Cost, Unit Retail, Extended Cost, NULL, Extended Retail`

**Example Output**:
```csv
H,101,VENDOR1,INV12345,,20231027
D,I,,1001,12,WIDGET A,,012345678905,,12,10.50,19.99,126.00,,
T,126.00
```

**Specific Logic**:
*   **Shipper Mode**: Detects "Shipper" items (Parent Item == Vendor Item).
    *   Parent item is written as Detail Type 'D'.
    *   Child items are written as Detail Type 'C' (or accumulated).
    *   Logic handles entering/leaving "Shipper Mode" and accumulating costs.

---

### 2.4. Fintech CSV (`convert_to_fintech.py`)

Format for Fintech integration.

*   **File Naming Convention**: `<input_filename>.csv`
*   **File Type**: CSV
*   **Encoding**: UTF-8
*   **Line Endings**: `\r\n` (Windows)
*   **Quoting**: `csv.QUOTE_ALL`

#### Structure & Fields

**Header Row**:
`"Division_id", "invoice_number", "invoice_date", "Vendor_store_id", "quantity_shipped", "Quantity_uom", "item_number", "upc_pack", "upc_case", "product_description", "unit_price"`

**Field Definitions**:

| Field Name | Source | Description |
| :--- | :--- | :--- |
| Division_id | Parameter | `fintech_division_id` from settings. |
| invoice_number | A-Rec | Invoice number. |
| invoice_date | A-Rec | Date formatted as `mm/dd/yyyy`. |
| Vendor_store_id | DB Lookup | Customer number fetched via `invFetcher`. |
| quantity_shipped | B-Rec | Quantity. |
| Quantity_uom | Logic | "EA" if multiplier > 1, else "CS". |
| item_number | B-Rec | Vendor item number. |
| upc_pack | Lookup | UPC from lookup table (index 1). |
| upc_case | Lookup | UPC from lookup table (index 2). |
| product_description | B-Rec | Description. |
| unit_price | B-Rec | Unit cost. |

**C Records**:
Written as: `[Division_id, invoice_number, invoice_date, Vendor_store_id, 1, "EA", 0, "", "", Description, Amount]`

---

### 2.5. Jolley Custom CSV (`convert_to_jolley_custom.py`)

A highly formatted CSV acting as a digital invoice document.

*   **File Naming Convention**: `<input_filename>.csv`
*   **File Type**: CSV
*   **Encoding**: UTF-8
*   **Line Endings**: `\n` (Unix)
*   **Dialect**: Unix

#### Structure

The file is divided into visual sections rather than a flat table.

1.  **Invoice Details Header**:
    *   Row: `Delivery Date, Terms, Invoice Number, Due Date, PO Number`
    *   Row: `[Delivery Date, Terms, Invoice Number, Due Date]` (Note: PO Number is currently omitted in the data row).
2.  **Address Block**:
    *   Columns: `Bill To:`, `<Address Block>`, `Ship To:`, `<Address Block>`
3.  **Item Table**:
    *   Header: `Description, UPC #, Quantity, UOM, Price, Amount`
    *   Rows: Item details.
4.  **Total**:
    *   Row: `,,,,Total:, <Invoice Total>`

**Example Output**:
```csv
Invoice Details

Delivery Date,Terms,Invoice Number,Due Date,PO Number
10/27/23,NET30,12345,11/26/23
Bill To:,100 MAIN ST,,Ship To:,100 MAIN ST
,,ANYTOWN, NY 12345,,,ANYTOWN, NY 12345

Description,UPC #,Quantity,UOM,Price,Amount
WIDGET A,012345678905,12,EA,$10.50,$126.00
,,,,Total:,$126.00
```

**Specific Logic**:
*   **DB Lookups**: Extensive AS400 queries to fetch Customer Name, Address, Terms, etc.
*   **Date Prettifying**: Converts `CYMD` dates to `mm/dd/yy`.
*   **UOM Lookup**: Fetches specific UOM codes (e.g., 'EA', 'CS') from `dacdata.odhst`.
*   **C Records**: Written as `[Description, '000000000000', 1, 'EA', Amount, Amount]`.

---

### 2.6. Stewart's Custom CSV (`convert_to_stewarts_custom.py`)

Similar to Jolley Custom but with specific field ordering and labeling for Stewart's.

*   **File Naming Convention**: `<input_filename>.csv`
*   **File Type**: CSV
*   **Encoding**: UTF-8
*   **Line Endings**: `\n` (Unix)

#### Structure

1.  **Invoice Details**: Similar to Jolley.
    *   Row: `Delivery Date, Terms, Invoice Number, Due Date, PO Number`
    *   Row: `[Delivery Date, Terms, Invoice Number, Due Date]` (Note: PO Number is currently omitted in the data row).
2.  **Address Block**: `Ship To:` is first, then `Bill To:`.
3.  **Item Table**:
    *   Header: `Invoice Number, Store Number, Item Number, Description, UPC #, Quantity, UOM, Price, Amount`
    *   Note the inclusion of Invoice/Store/Item numbers in the detail rows.

**C Records**:
Written as: `[Description, '000000000000', 1, 'EA', Amount, Amount]`.

---

### 2.7. Yellow Dog CSV (`convert_to_yellowdog_csv.py`)

Format for Yellow Dog Inventory.

*   **File Naming Convention**: `<input_filename>.csv`
*   **File Type**: CSV
*   **Encoding**: UTF-8
*   **Line Endings**: `\r\n` (Windows)
*   **Quoting**: `csv.QUOTE_ALL`

#### Structure & Fields

**Header Row**:
`"Invoice Total", "Description", "Item Number", "Cost", "Quantity", "UOM Desc.", "Invoice Date", "Invoice Number", "Customer Name", "Customer PO Number", "UPC"`

**Specific Logic**:
*   **LIFO Processing**: B and C records are collected and then written in reverse order (`pop()` from list).
*   **UOM Description**: Fetched via `invFetcher`.
*   **C Records**: Mapped to specific columns (Item Number = 9999999, Qty = 1).

---

### 2.8. Scannerware (`convert_to_scannerware.py`)

A fixed-width/text format for legacy scanner hardware.

*   **File Naming Convention**: `<input_filename>` (or .txt)
*   **File Type**: Text / Fixed Width
*   **Encoding**: UTF-8 (Binary write mode used)

#### Structure

**A Record (Header)**:
| Position | Length | Content |
| :--- | :--- | :--- |
| 0 | 1 | Record Type ('A') |
| 1 | 6 | Padding (Configurable) |
| 7 | 7 | Invoice Number (Last 7 digits) |
| 14 | 3 | Spaces |
| 17 | 6 | Invoice Date (MMDDYY) |
| 23 | - | Invoice Total |
| End | - | Optional Append Text |

**B Record (Detail)**:
| Position | Length | Content |
| :--- | :--- | :--- |
| 0 | 1 | Record Type ('B') |
| 1 | 14 | UPC (Left justified) |
| 15 | 25 | Description (Truncated) |
| 40 | Var | Vendor Item |
| Var | Var | Unit Cost |
| Var | 2 | Spaces |
| Var | Var | Unit Multiplier |
| Var | Var | Qty |
| Var | Var | SRP |
| Var | 3 | '001' |
| Var | 7 | Spaces |

**C Record**:
`C` + `Description (25 chars)` + `   ` + `Amount`

**Example Output**:
```text
A      12345   102723126.00
B012345678905 WIDGET A                 100110.50  121219.99001       
```

**Specific Logic**:
*   **Invoice Date Offset**: Can add an offset (in days) to the invoice date via `invoice_date_offset` parameter.
*   **Data Truncation**: Descriptions are truncated to 25 characters.

---

### 2.9. Scansheet Type A (`convert_to_scansheet_type_a.py`)

Generates an Excel spreadsheet with barcode images for scanning.

*   **File Naming Convention**: `<input_filename>.xlsx`
*   **File Type**: Excel (.xlsx)
*   **Library**: `openpyxl`, `python-barcode`

#### Structure

*   **Rows**:
    *   Header: Invoice Number.
    *   Items: UPC, Item, Description, Pack, U/M, Qty, Price, Retail.
*   **Barcodes**:
    *   Generates UPC-A barcode images (PNG) using `python-barcode`.
    *   Inserts images into Column A.
    *   Resizes Column A width and Row heights to fit the barcode image.

**Specific Logic**:
*   **DB Query**: Fetches item details from `dacdata.odhst` and `dacdata.dsanrep`.
*   **Filtering**: Only includes items where `Qty <> 0`.
*   **Image Generation**: Creates temp PNG files for barcodes, adds borders, inserts into Excel, then cleans up.
*   **Barcode Settings**: DPI 130, Module Height 5.0.

---

### 2.10. EDI Tweaks (`edi_tweaks.py`)

A specialized processor that outputs a modified version of the input EDI file. It applies specific transformations ("tweaks") to the records based on configuration.

*   **File Naming Convention**: `<input_filename>` (or `<input_filename>.txt` if `force_txt_file_ext` is enabled)
*   **File Type**: Text / EDI
*   **Encoding**: UTF-8 (Default system encoding)
*   **Line Endings**: `\r\n` (Windows)

#### Structure

Retains the standard EDI structure (A, B, C records) but modifies specific fields within those records.

**A Record (Header) Transformations**:
*   **Padding**: If `pad_a_records` is enabled, the Customer/Vendor field is left-aligned and padded to `a_record_padding_length`.
*   **Date Offset**: `invoice_date` can be shifted by `invoice_date_offset` days.
*   **Date Formatting**: `invoice_date` can be reformatted using `invoice_date_custom_format_string` (e.g., `%Y%m%d`).
*   **Append Text**: Custom text (`a_record_append_text`) can be appended to the end of the line. Supports `%po_str%` placeholder to inject fetched PO numbers.

**B Record (Detail) Transformations**:
*   **UPC Override**: Replaces `upc_number` with a value from the UPC lookup table if `override_upc_bool` is enabled. Supports category filtering.
*   **Retail UOM**: A complex transformation for specific retail unit-of-measure logic:
    *   `Unit Cost` = (Cost / 100) / Unit Multiplier
    *   `Qty` = Unit Multiplier * Qty
    *   `Unit Multiplier` = '000001'
    *   `UPC` is padded/truncated to `upc_target_length`.
*   **UPC Check Digit**: Recalculates and appends the check digit if `calculate_upc_check_digit` is enabled. Handles UPCE -> UPCA conversion.
*   **Negative Handling**: Moves negative signs to the front for numeric fields (Cost, Multiplier, Qty, SRP).

**C Record (Charges) Transformations**:
*   **Split Sales Tax**: If `split_prepaid_sales_tax_crec` is enabled, "CTABSales Tax" records are split into component parts using `CRecGenerator`.

**Example Output (Tweaked B Record)**:
```text
B012345678905 WIDGET A                 100110.50  010000010001219.99001000000
```

---

## 3. EDI Specifications (C-Records)

**Source**: `core/edi/c_rec_generator.py`

The application generates "C Records" to represent charges, credits, or comments, particularly for split sales tax.

**Format**:
`C{charge_type}{description}{amount}`

**Field Definitions**:

| Field | Length | Description | Logic |
| :--- | :--- | :--- | :--- |
| Record Type | 1 | 'C' | Constant. |
| Charge Type | 3 | e.g., 'TAB' | Configurable code. |
| Description | 25 | Text | Left justified, padded with spaces. |
| Amount | 9 | Numeric | Right justified, 0-padded. Implied decimal (no dot). Negative values have '-' at index 0. |

**Example**:
`CTABSales Tax                000001250` (Represents $12.50 tax)

## 4. Validation Rules

While specific validation logic is often embedded in the `dispatch` or `interface` layers, the output generation modules enforce certain data integrity rules:

1.  **UPC Validation**:
    *   Check digits are calculated for 11-digit UPCs to form 12-digit UPC-A.
    *   UPC-E to UPC-A conversion is supported.
    *   Invalid UPCs may be defaulted to padding or empty strings depending on settings.
2.  **Numeric Formatting**:
    *   Costs and Prices are typically formatted to 2 decimal places.
    *   Quantities are stripped of leading zeros.
3.  **Date Formatting**:
    *   Dates are often converted from `CYMD` (Century Year Month Day) or `MMDDYY` to standard formats like `MM/DD/YYYY` or `YYYYMMDD`.
4.  **Data Truncation**:
    *   Fixed-width formats (Scannerware) truncate descriptions to fit field limits (e.g., 25 chars).
